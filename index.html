<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Microscope Metronome</title>
  <style>
    body { font-family: system-ui, Arial; margin: 18px; }
    .card { max-width: 560px; border: 1px solid #ddd; border-radius: 14px; padding: 16px; }
    .row { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; margin-top: 10px; }
    .big { font-size: 34px; font-weight: 750; }
    .mid { font-size: 24px; }
    .sol { font-size: 28px; font-weight: 700; margin-top: 8px; }
    button { font-size: 18px; padding: 12px 14px; border-radius: 12px; border: 1px solid #bbb; background: #f7f7f7; }
    input { font-size: 18px; padding: 10px; width: 120px; border-radius: 10px; border: 1px solid #bbb; }
    label { font-size: 16px; color: #444; }
    .small { margin-top: 10px; color: #555; }
    .pill { display: inline-block; padding: 4px 10px; border-radius: 999px; border: 1px solid #ccc; font-size: 14px; }
  </style>
</head>
<body>
  <div class="card">
    <div class="big">Seconds: <span id="sec">0</span></div>
    <div class="mid">Frame: <span id="frame">0</span></div>

    <div class="sol">Solution: <span id="solution">Tyrodeâ€™s</span></div>
    <div class="small">Next change at frame: <span id="next">101</span></div>

    <div class="row">
      <button id="startBtn" onclick="start()">Start</button>
      <button onclick="pause()">Pause</button>
      <button onclick="resetAll()">Reset</button>
      <span class="pill" id="status">stopped</span>
    </div>

    <div class="row">
      <label>FPS (frames/sec):</label>
      <input id="fps" type="number" min="0.1" step="0.1" value="1" />
      <label><input id="beep" type="checkbox" /> beep each second</label>
    </div>

    <div class="small">
      Ranges (by frame):
      0â€“100 Tyrodeâ€™s, 101â€“200 Depolarization, 201â€“300 Tyrodeâ€™s, 301â€“400 FSK,
      401â€“450 Tyrodeâ€™s, 451â€“550 Depolarization, 551â€“750 Tyrodeâ€™s, 751â€“850 NH4Cl
    </div>
  </div>

<script>
  const schedule = [
    { end: 100, label: "Tyrodeâ€™s" },
    { end: 200, label: "Depolarization" },
    { end: 300, label: "Tyrodeâ€™s" },
    { end: 400, label: "FSK" },
    { end: 450, label: "Tyrodeâ€™s" },
    { end: 550, label: "Depolarization" },
    { end: 750, label: "Tyrodeâ€™s" },
    { end: 850, label: "NH4Cl" },
  ];

  let running = false;
  let t0 = null;
  let pausedAt = null;
  let lastStage = 0;

  function getStage(frame) {
    for (let i = 0; i < schedule.length; i++) {
      if (frame <= schedule[i].end) return i;
    }
    return schedule.length;
  }

  function getFps() {
    const v = parseFloat(document.getElementById("fps").value);
    return (Number.isFinite(v) && v > 0) ? v : 1;
  }

  function loudBeep(times = 3) {
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    let count = 0;

    function singleBeep() {
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();

      osc.type = "single";
      osc.frequency.value = 600;   // sharp high tone
      gain.gain.value = 0.2;        // loud

      osc.connect(gain);
      gain.connect(ctx.destination);

      osc.start();
      setTimeout(() => {
        osc.stop();
        count++;
        if (count < times) {
          setTimeout(singleBeep, 200);
        } else {
          ctx.close();
        }
      }, 200);
    }

    singleBeep();
  }

  function tick() {
    if (!running) return;

    const now = performance.now();
    const elapsedMs = now - t0;
    const sec = Math.floor(elapsedMs / 1000);
    const fps = getFps();
    const frame = Math.floor(sec * fps);

    document.getElementById("sec").textContent = sec;
    document.getElementById("frame").textContent = frame;

    const stageIndex = getStage(frame);

    if (stageIndex < schedule.length) {
      document.getElementById("solution").textContent = schedule[stageIndex].label;
    } else {
      document.getElementById("solution").textContent = "Done";
    }

    // ðŸ”´ BEEP ONLY when stage changes
    if (stageIndex !== lastStage) {
      loudBeep(4); // number of beeps
      if (navigator.vibrate) navigator.vibrate([200,100,200,100,200]);
      lastStage = stageIndex;
    }

    requestAnimationFrame(tick);
  }

  function start() {
    if (running) return;
    const base = pausedAt ?? 0;
    t0 = performance.now() - base;
    running = true;
    requestAnimationFrame(tick);
  }

  function pause() {
    if (!running) return;
    running = false;
    pausedAt = performance.now() - t0;
  }

  function resetAll() {
    running = false;
    t0 = null;
    pausedAt = null;
    lastStage = 0;
    document.getElementById("sec").textContent = 0;
    document.getElementById("frame").textContent = 0;
    document.getElementById("solution").textContent = schedule[0].label;
  }
</script>
</body>
</html>

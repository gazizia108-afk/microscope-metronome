<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Microscope Metronome</title>
  <style>
    body { font-family: system-ui, Arial; margin: 18px; }
    .card { max-width: 560px; border: 1px solid #ddd; border-radius: 14px; padding: 16px; }
    .row { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; margin-top: 10px; }
    .big { font-size: 34px; font-weight: 750; }
    .mid { font-size: 24px; }
    .sol { font-size: 28px; font-weight: 700; margin-top: 8px; }
    button { font-size: 18px; padding: 12px 14px; border-radius: 12px; border: 1px solid #bbb; background: #f7f7f7; }
    input { font-size: 18px; padding: 10px; width: 120px; border-radius: 10px; border: 1px solid #bbb; }
    label { font-size: 16px; color: #444; }
    .small { margin-top: 10px; color: #555; }
    .pill { display: inline-block; padding: 4px 10px; border-radius: 999px; border: 1px solid #ccc; font-size: 14px; }
  </style>
</head>
<body>
  <div class="card">
    <div class="big">Seconds: <span id="sec">0</span></div>
    <div class="mid">Frame: <span id="frame">0</span></div>

    <div class="sol">Solution: <span id="solution">Tyrode’s</span></div>
    <div class="small">Next change at frame: <span id="next">101</span></div>

    <div class="row">
      <button id="startBtn" onclick="start()">Start</button>
      <button onclick="pause()">Pause</button>
      <button onclick="resetAll()">Reset</button>
      <span class="pill" id="status">stopped</span>
    </div>

    <div class="row">
      <label>FPS (frames/sec):</label>
      <input id="fps" type="number" min="0.1" step="0.1" value="1" />
      <label><input id="beep" type="checkbox" /> beep each second</label>
    </div>

    <div class="small">
      Ranges (by frame):
      0–100 Tyrode’s, 101–200 Depolarization, 201–300 Tyrode’s, 301–400 FSK,
      401–450 Tyrode’s, 451–550 Depolarization, 551–750 Tyrode’s, 751–850 NH4Cl
    </div>
  </div>

<script>
  // Frame schedule
  const schedule = [
    { end: 100, label: "Tyrode’s", next: 101 },
    { end: 200, label: "Depolarization", next: 201 },
    { end: 300, label: "Tyrode’s", next: 301 },
    { end: 400, label: "FSK", next: 401 },
    { end: 450, label: "Tyrode’s", next: 451 },
    { end: 550, label: "Depolarization", next: 551 },
    { end: 750, label: "Tyrode’s", next: 751 },
    { end: 850, label: "NH4Cl", next: 851 },
  ];

  let running = false;
  let t0 = null;            // performance.now() at start
  let pausedAt = null;      // elapsed ms when paused
  let timer = null;
  let lastWholeSecond = -1;

  function getStage(frame) {
    for (const s of schedule) if (frame <= s.end) return s;
    return { label: "Done", next: "-" };
  }

  function getFps() {
    const v = parseFloat(document.getElementById("fps").value);
    return (Number.isFinite(v) && v > 0) ? v : 1;
  }

  function setStatus(text) {
    document.getElementById("status").textContent = text;
  }

  function beep() {
    // Simple beep without external files
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    o.type = "sine";
    o.frequency.value = 880;
    g.gain.value = 0.05;
    o.connect(g);
    g.connect(ctx.destination);
    o.start();
    setTimeout(() => { o.stop(); ctx.close(); }, 80);
  }

  function tick() {
    if (!running) return;

    const now = performance.now();
    const elapsedMs = now - t0;
    const sec = Math.floor(elapsedMs / 1000);
    const fps = getFps();
    const frame = Math.floor(sec * fps);

    document.getElementById("sec").textContent = sec;
    document.getElementById("frame").textContent = frame;

    const st = getStage(frame);
    document.getElementById("solution").textContent = st.label;
    document.getElementById("next").textContent = st.next;

    // Beep once per new second
    if (sec !== lastWholeSecond) {
      lastWholeSecond = sec;
      if (document.getElementById("beep").checked) beep();
      if (navigator.vibrate) navigator.vibrate(30);
    }

    // Smooth UI updates
    requestAnimationFrame(tick);
  }

  function start() {
    if (running) return;

    // If paused, resume from pausedAt
    const base = pausedAt ?? 0;
    t0 = performance.now() - base;

    running = true;
    setStatus("running");
    requestAnimationFrame(tick);
  }

  function pause() {
    if (!running) return;
    running = false;
    pausedAt = performance.now() - t0;
    setStatus("paused");
  }

  function resetAll() {
    running = false;
    t0 = null;
    pausedAt = null;
    lastWholeSecond = -1;
    document.getElementById("sec").textContent = 0;
    document.getElementById("frame").textContent = 0;
    const st = getStage(0);
    document.getElementById("solution").textContent = st.label;
    document.getElementById("next").textContent = st.next;
    setStatus("stopped");
  }
</script>
</body>
</html>
